<div class="wrapper">
  <div class="header-home-admin">
    <app-navbar></app-navbar>
  </div>

  <div class="body-admin">
    <!-- Encabezado -->
    <div class="row mt-4 mb-3">
      <div class="col-12">
        <span class="title-perfil">Inventario de Productos</span>
      </div>
    </div>

    <div class="container">
      <!-- Fila: buscador + resumen -->
      <div class="row mt-3 align-items-center">
        <div class="col-lg-8 col-md-12 mb-3">
          <div class="alert alert-primary" role="alert">
            <span class="title-table">Busca productos por nombre o clave</span>
          </div>

          <div class="pos-search">
            <input
              type="text"
              class="form-control pos-search__input"
              [formControl]="buscando"
              placeholder="Escribe para filtrar…"
            />
            <i class="bi bi-search pos-search__icon"></i>
          </div>
          <small class="text-muted">Total mostrados: {{ totalRegistros }}</small>
        </div>

        <div class="col-lg-4 col-md-12 mb-3">
          <div class="mini-summary card p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="mini-summary__label">Registros</div>
                <div class="mini-summary__value">{{ totalRegistros }}</div>
              </div>
              <div class="text-end">
                <div class="mini-summary__label">Estado</div>
                <div class="mini-summary__value total">Inventario</div>
              </div>
            </div>

            <div class="d-grid gap-2 mt-3">
              <button class="btn btn-outline-secondary" type="button" (click)="buscando.setValue('')">
                Limpiar filtro
              </button>
              <button class="btn btn-primary" type="button" (click)="exportarPDF()">
                Exportar PDF
              </button>
            </div>
          </div>
        </div>

      <!-- Tarjeta principal con la tabla -->
      <div class="card card--elev">
        <div class="card-header card-header--gradient">
          <span class="title-card">Lista de productos</span>
        </div>

        <div class="card-body">
          <!-- Loading -->
          <div *ngIf="cargando" class="mb-2">
            <span class="spinner me-2">⏳</span> Cargando…
          </div>

          <div class="table-wrapper">
            <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z0 mat-mdc-table w-100">

              <!-- Clave -->
              <ng-container matColumnDef="clave">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Clave</th>
                <td mat-cell *matCellDef="let p">{{ p.clave }}</td>
              </ng-container>

              <!-- Nombre -->
              <ng-container matColumnDef="nombre">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Producto</th>
                <td mat-cell *matCellDef="let p">
                  <div class="prod-name">{{ p.nombre }}</div>
                  <div class="prod-extra">ID: {{ p.id || '—' }}</div>
                </td>
              </ng-container>

              <!-- Categoría -->
              <ng-container matColumnDef="categoria">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoría</th>
                <td mat-cell *matCellDef="let p">{{ p.categoria || '—' }}</td>
              </ng-container>

              <!-- Presentacion -->
              <ng-container matColumnDef="presentacion">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Presentación</th>
                <td mat-cell *matCellDef="let p">
                  <ng-container *ngIf="p?.contenido != null && p?.unidad; else sinPresentacion">
                    {{ p.contenido }} {{ p.unidad }}
                  </ng-container>
                  <ng-template #sinPresentacion>—</ng-template>
                </td>
              </ng-container>

              <!-- Precio -->
              <ng-container matColumnDef="precio">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-end">Precio</th>
                <td mat-cell *matCellDef="let p" class="text-end">
                  {{ p.precio | currency:'MXN':'symbol-narrow' }}
                </td>
              </ng-container>

              <!-- Stock -->
              <ng-container matColumnDef="stock">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-center">Stock</th>
                <td mat-cell *matCellDef="let p" class="text-center">
                  {{ p.stock }}
                </td>
              </ng-container>

              <!-- Estado -->
              <ng-container matColumnDef="estado">
                <th mat-header-cell *matHeaderCellDef class="text-center">Estado</th>
                <td mat-cell *matCellDef="let p" class="text-center">
                  <span
                    class="badge"
                    [ngClass]="{
                      'bg-success': estadoStock(p) === 'ok',
                      'bg-warning': estadoStock(p) === 'bajo',
                      'bg-danger': estadoStock(p) === 'sin'
                    }"
                  >
                    {{ estadoStock(p) === 'ok' ? 'OK' : (estadoStock(p) === 'bajo' ? 'Bajo' : 'Sin stock') }}
                  </span>
                </td>
              </ng-container>

              <!-- Eliminar -->
              <ng-container matColumnDef="eliminar">
                <th mat-header-cell *matHeaderCellDef class="text-center">Eliminar</th>
                <td mat-cell *matCellDef="let p" class="text-center">
                  <i class="bi bi-trash3-fill"
                    style="cursor:pointer"
                    (click)="deleteProducto(p)"></i>
                </td>
              </ng-container>

              <!-- Header / Rows -->
              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

              <!-- Empty state -->
              <tr class="mat-row" *ngIf="!cargando && dataSource.data.length === 0">
                <td class="mat-cell text-center" [attr.colspan]="displayedColumns.length">
                  <i class="bi bi-emoji-neutral"></i> No hay productos para mostrar.
                </td>
              </tr>
            </table>
          </div>

          <!-- Paginador -->
          <mat-paginator
            [pageSize]="10"
            [pageSizeOptions]="[5,10,25,50]"
            showFirstLastButtons
            class="mt-3">
          </mat-paginator>
        </div>
      </div>
    </div>
  </div>
</div>
