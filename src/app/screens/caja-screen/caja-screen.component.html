<div class="caja-page">
  <div class="header-home-admin">
    <app-navbar></app-navbar>
  </div>

  <div class="body-admin">
    <!-- Encabezado -->
    <div class="row mt-4 mb-3">
      <div class="col-12">
        <span class="title-perfil">Caja</span>
      </div>
    </div>

    <div class="container">
      <!-- Resumen + Ingreso + Mini-chart -->
      <div class="row g-3">
        <!-- Resumen -->
        <div class="col-lg-5 col-md-12">
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="mini-summary__label">Saldo en caja</div>
                <div class="mini-summary__value dinero">{{ saldoCaja | currency:'MXN':'symbol-narrow' }}</div>
              </div>
              <div class="text-end">
                <div class="mini-summary__label">Vendido (c/IVA)</div>
                <div class="mini-summary__value ok">{{ totalVendido | currency:'MXN':'symbol-narrow' }}</div>
                <div class="mini-summary__label mt-2">Gastado</div>
                <div class="mini-summary__value danger">{{ totalGastado | currency:'MXN':'symbol-narrow' }}</div>
              </div>
            </div>
            <div class="d-grid gap-2 mt-3">
              <button class="btn btn-outline-secondary" type="button" (click)="exportarPDF()">
                Exportar PDF
              </button>
            </div>
          </div>
        </div>

        <!-- Ingreso directo -->
        <div class="col-lg-4 col-md-12">
          <div class="card p-3">
            <div class="title-card mb-2">Ingreso directo</div>
            <div class="row g-2">
              <div class="col-5">
                <label class="form-label required">Monto</label>
                <input class="form-control" type="number" min="0" step="0.01" [formControl]="ingresoCtrl" placeholder="0.00">
              </div>
              <div class="col-7">
                <label class="form-label">Nota</label>
                <input class="form-control" type="text" [formControl]="notaCtrl" placeholder="Opcional">
              </div>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-3">
              <button class="btn btn-primary" type="button" (click)="registrarIngreso()" [disabled]="guardandoIngreso">
                {{ guardandoIngreso ? 'Guardando…' : 'Ingresar' }}
              </button>
            </div>
            <small class="text-danger d-block mt-2" *ngIf="msgIngreso && msgIngreso.includes('No se pudo')">{{ msgIngreso }}</small>
            <small class="text-success d-block mt-2" *ngIf="msgIngreso && !msgIngreso.includes('No se pudo')">{{ msgIngreso }}</small>
          </div>
        </div>

        <!-- Mini gráfico -->
        <div class="col-lg-3 col-md-12 text-center">
          <div class="card p-3 h-100 d-flex align-items-center justify-content-center">
            <canvas
              baseChart
              width="260"
              height="260"
              type="doughnut"
              [data]="doughnutData"
              [plugins]="doughnutPlugins"
              [options]="doughnutOptions">
            </canvas>
          </div>
        </div>
      </div>

      <!-- Ventas -->
      <div class="card card--elev mt-4">
        <div class="card-header card-header--gradient d-flex flex-wrap align-items-center justify-content-between">
          <span class="title-card">Ventas</span>
          <div class="pos-search ms-auto">
            <input
              type="text"
              class="form-control pos-search__input"
              [formControl]="buscarVentas"
              placeholder="Buscar por monto/fecha…"/>
            <i class="bi bi-search pos-search__icon"></i>
          </div>
        </div>
        <div class="card-body">
          <div *ngIf="cargandoVentas" class="mb-2"><span class="spinner me-2">⏳</span> Cargando…</div>

          <div class="table-wrapper">
            <table mat-table [dataSource]="dsVentas" matSort #sortVentas="matSort" class="mat-elevation-z0 mat-mdc-table w-100">

              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
                <td mat-cell *matCellDef="let v">{{ v.id }}</td>
              </ng-container>

              <ng-container matColumnDef="fecha">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
                <td mat-cell *matCellDef="let v">{{ v.fecha }}</td>
              </ng-container>

              <ng-container matColumnDef="subtotal">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-end">Subtotal</th>
                <td mat-cell *matCellDef="let v" class="text-end">{{ v.subtotal | currency:'MXN':'symbol-narrow' }}</td>
              </ng-container>

              <ng-container matColumnDef="iva">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-end">IVA</th>
                <td mat-cell *matCellDef="let v" class="text-end">{{ v.iva | currency:'MXN':'symbol-narrow' }}</td>
              </ng-container>

              <ng-container matColumnDef="total">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-end">Total</th>
                <td mat-cell *matCellDef="let v" class="text-end"><strong>{{ v.total | currency:'MXN':'symbol-narrow' }}</strong></td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="colsVentas"></tr>
              <tr mat-row *matRowDef="let row; columns: colsVentas;"></tr>

              <tr class="mat-row" *ngIf="!cargandoVentas && dsVentas.data.length === 0">
                <td class="mat-cell text-center" [attr.colspan]="colsVentas.length">No hay ventas.</td>
              </tr>
            </table>
          </div>

          <mat-paginator #pagVentas [pageSize]="10" [pageSizeOptions]="[5,10,25,50]" showFirstLastButtons class="mt-3"></mat-paginator>
        </div>
      </div>

      <!-- Gastos -->
      <div class="card card--elev mt-4">
        <div class="card-header card-header--gradient d-flex flex-wrap align-items-center justify-content-between">
          <span class="title-card">Gastos</span>
          <div class="pos-search ms-auto">
            <input
              type="text"
              class="form-control pos-search__input"
              [formControl]="buscarGastos"
              placeholder="Buscar por tipo/monto/fecha…"/>
            <i class="bi bi-search pos-search__icon"></i>
          </div>
        </div>
        <div class="card-body">
          <div *ngIf="cargandoGastos" class="mb-2"><span class="spinner me-2">⏳</span> Cargando…</div>

          <div class="table-wrapper">
            <table mat-table [dataSource]="dsGastos" matSort #sortGastos="matSort" class="mat-elevation-z0 mat-mdc-table w-100">

              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
                <td mat-cell *matCellDef="let g">{{ g.id }}</td>
              </ng-container>

              <ng-container matColumnDef="fecha">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
                <td mat-cell *matCellDef="let g">{{ g.fecha }}</td>
              </ng-container>

              <ng-container matColumnDef="tipo">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo/Proveedor</th>
                <td mat-cell *matCellDef="let g">{{ g.tipo }}</td>
              </ng-container>

              <ng-container matColumnDef="monto">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-end">Monto</th>
                <td mat-cell *matCellDef="let g" class="text-end"><strong>{{ g.monto | currency:'MXN':'symbol-narrow' }}</strong></td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="colsGastos"></tr>
              <tr mat-row *matRowDef="let row; columns: colsGastos;"></tr>

              <tr class="mat-row" *ngIf="!cargandoGastos && dsGastos.data.length === 0">
                <td class="mat-cell text-center" [attr.colspan]="colsGastos.length">No hay gastos.</td>
              </tr>
            </table>
          </div>

          <mat-paginator #pagGastos [pageSize]="10" [pageSizeOptions]="[5,10,25,50]" showFirstLastButtons class="mt-3"></mat-paginator>
        </div>
      </div>
      <div class="card card--elev mt-4">
        <div class="card-header card-header--gradient d-flex flex-wrap align-items-center justify-content-between">
          <span class="title-card">Ingresos directos</span>
          <div class="pos-search ms-auto">
            <input
              type="text"
              class="form-control pos-search__input"
              [formControl]="buscarIngresos"
              placeholder="Buscar por monto/nota/fecha…"/>
            <i class="bi bi-search pos-search__icon"></i>
          </div>
        </div>
        <div class="card-body">
          <div *ngIf="cargandoIngresos" class="mb-2"><span class="spinner me-2">⏳</span> Cargando…</div>

          <div class="table-wrapper">
            <table mat-table [dataSource]="dsIngresos" matSort #sortIngresos="matSort" class="mat-elevation-z0 mat-mdc-table w-100">
              <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
                <td mat-cell *matCellDef="let i">{{ i.id }}</td>
              </ng-container>

              <ng-container matColumnDef="fecha">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
                <td mat-cell *matCellDef="let i">{{ i.fecha }}</td>
              </ng-container>

              <ng-container matColumnDef="monto">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-end">Monto</th>
                <td mat-cell *matCellDef="let i" class="text-end"><strong>{{ i.monto | currency:'MXN':'symbol-narrow' }}</strong></td>
              </ng-container>

              <ng-container matColumnDef="nota">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Nota</th>
                <td mat-cell *matCellDef="let i">{{ i.nota || '—' }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="colsIngresos"></tr>
              <tr mat-row *matRowDef="let row; columns: colsIngresos;"></tr>

              <tr class="mat-row" *ngIf="!cargandoIngresos && dsIngresos.data.length === 0">
                <td class="mat-cell text-center" [attr.colspan]="colsIngresos.length">No hay ingresos.</td>
              </tr>
            </table>
          </div>
          <mat-paginator #pagIngresos [pageSize]="10" [pageSizeOptions]="[5,10,25,50]" showFirstLastButtons class="mt-3"></mat-paginator>
        </div>
      </div>
    </div>
  </div>
</div>
